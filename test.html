<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>

</head>
<body>

<div id="root"></div>


<script type="text/javascript">

  function memoEqual(prevProps, nextProps) {
    return Object.keys(nextProps).reduce((p, next) => {
      if (typeof prevProps[next] == "function" && typeof nextProps[next] == "function") {
        return p;
      }
      if (prevProps[next] != nextProps[next]) {
        return p && false;
      } else {
        return p;
      }
    }, true);
  }


  function loadFrontegg(contextOptions) {
    const reactHidden = document.createElement("div");
    reactHidden.setAttribute("id", "frontegg-react-middleware");
    reactHidden.style.display = "none";
    document.body.append(reactHidden);

    const { Provider, Consumer } = React.createContext({
      baseUrl: "test"
    });


    class Reports extends React.Component {
      state = {
        clicked: false
      };

      render() {
        return React.createElement("div", null, React.createElement(
          React.Fragment, null,
          React.createElement("button", { onClick: () => this.setState({ clicked: !this.state.clicked }) }, this.state.clicked ? "ON" : "OFF"),
          React.createElement("div", null, `Button Toggle: ${this.state.clicked}`),
          React.createElement("div", null, `Context Value: ${this.props.baseUrl}`)
        ));
      }
    }

    class Webhooks extends React.Component {
      render() {
        return "Webhooks";
      }
    }

    const pluginsMap = {
      reports: React.memo(Reports, memoEqual),
      webhooks: React.memo(Webhooks, memoEqual)
    };

    class App extends React.Component {
      state = {
        plugin: null,
        node: null
      };

      componentDidMount() {
        document.addEventListener("frontegg_router_application", evt => {
          this.setState(evt.fronteggData);
        });
      }

      render() {
        console.log("App.render()");
        const { plugin, node } = this.state;

        if (plugin && node) {
          const nodeRef = document.getElementById(node);
          if (nodeRef == null) {
            console.error(`Node not found in document id: ${node}`);
            return null;
          }
          if (pluginsMap[plugin] == null) {
            console.error(`Plugin ${plugin} not found`);
            return null;
          }
          return ReactDOM.createPortal(React.createElement(Consumer, null, (context) => {
            return React.createElement(pluginsMap[plugin], { ...context });
          }), nodeRef, plugin);
        }

        return null;
      }
    }

    const renderFunction = (contextOptions) => {
      const frontegg = React.createElement(Provider, { value: contextOptions }, React.createElement(App));
      ReactDOM.render(frontegg, reactHidden);
    };
    renderFunction(contextOptions);
    return renderFunction;
  }

  function loadPlugin(plugin, node) {
    const event = new Event("frontegg_router_application");
    event.fronteggData = { plugin, node };
    document.dispatchEvent(event);
  }

  const fronteggContext = loadFrontegg({ baseUrl: "MMM" });
</script>
</body>
</html>
